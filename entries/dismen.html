<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="author" content="Joseph Moore">
    <meta name="description" content="Self-learning HTML and CSS basics">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tmlt_blog</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="../fonts/ibm_plex/IBM_Plex.css">
    <link rel="stylesheet" href="../fonts/ibm_plex_mono/IBM_Plex.css">
    <link rel="icon" href="../focus.png">
</head>
<body>
    <header style="background-color: #23507f;">
        <a class="header-title" href="../index.html">Tmlt_blog</a>
        <p class="header-link-container">
            <a class="header-link" href="https://github.com/Tumultur" target="_blank">Github</a>
        </p>
    </header>
    <main>
        <div class="entry-header">
            <p class="entry-header-title">Editing and repacking Windows images</p>
            <p class="entry-header-date">2022-11-09</p>
        </div>
        <div class="entry-paragraph">
            <p class="entry-paragraph-title">caonima</p>
            <p class="entry-paragraph-content">
                All commands are executed in elevated PowerShell, but Command Prompt should do as well. <span class="entry-paragraph-inline-code">efi\source\install.wim</span> is first extracted from the .iso file, and mounted using the following command.
            </p>
        </div>
        <table class="entry-code">
            <tr class="entry-code-line">
                <td class="entry-code-line-number">1</td>
                <td class="entry-code-content">Mount-WindowsImage -ImagePath <span class="entry-code-highlight">%WIM_PATH%</span> -Index <span class="entry-code-highlight">%IMAGE_INDEX%</span></td>
            </tr>
        </table>
        <div class="entry-paragraph">
            <p class="entry-paragraph-content">
                In which <span class="entry-paragraph-inline-code">%IMAGE_INDEX%</span> is the order of the system in the image, counted from 1. For example, in LTSC 2021, the normal variant is numbered 1, and the IoT variant is 2.
            </p>
            <p class="entry-paragraph-content">
                Two commands are used: <span class="entry-paragraph-inline-code">Add-AppxProvisionedPackage</span> to install application package and <span class="entry-paragraph-inline-code">Enable-WindowsOptionalFeature</span> to enable optional features.
            </p>
            <p class="entry-paragraph-content">
                The former is used to install App Installer, which already includes winget.
            </p>
            <p class="entry-paragraph-content">
                adguard's <a href="https://store.rg-adguard.net/" target=_blank>line generator</a> can be used to generate download link for the application and its dependencies. Respective certificates can be downloaded from winget's GitHub Repo. A certificate is not required by most applications.
            </p>
        </div>
        <table class="entry-code">
            <tr class="entry-code-line">
                <td class="entry-code-line-number">1</td>
                <td class="entry-code-content">Add-AppxProvisionedPackage -Path <span class="entry-code-highlight">%MODIFIED_SYSTEM_PATH%</span> -Folder <span class="entry-code-highlight">%APPX-PATH%</span></td>
            </tr>
        </table>
        <div class="entry-paragraph">
            <p class="entry-paragraph-content">
                In which <span class="entry-paragraph-inline-code">%MODIFIED_SYSTEM_PATH%</span> is the root directory of mounted system, and <span class="entry-paragraph-inline-code">%APPX-PATH%</span> is a folder containing all required files (application package itself, dependencies and certificate).
            </p>
            <p class="entry-paragraph-content">
                The latter is used to enable optional features that are disabled by default e.g. WSL and Hyper-V.
            </p>
            <p class="entry-paragraph-content">
                <span class="entry-paragraph-inline-code">Get-WindowsOptionalFeature</span> can be used to obtain alias for desired feature.
            </p>
        </div>
        <table class="entry-code">
            <tr class="entry-code-line">
                <td class="entry-code-line-number">1</td>
                <td class="entry-code-content">Get-WindowsOptionalFeature -Online</td>
            </tr>
            <tr class="entry-code-line">
                <td class="entry-code-line-number">2</td>
                <td class="entry-code-content">...</td>
            </tr>
            <tr class="entry-code-line">
                <td class="entry-code-line-number">3</td>
                <td class="entry-code-content">FeatureName : Microsoft-Windows-Subsystem-Linux</td>
            </tr>
            <tr class="entry-code-line">
                <td class="entry-code-line-number">4</td>
                <td class="entry-code-content">State : Disabled</td>
            </tr>
            <tr class="entry-code-line">
                <td class="entry-code-line-number">5</td>
                <td class="entry-code-content">...</td>
            </tr>
        </table>
        <table class="entry-code">
            <tr class="entry-code-line">
                <td class="entry-code-line-number">1</td>
                <td class="entry-code-content">Enable-WindowsOptionalFeature -Path <span class="entry-code-highlight">%MODIFIED_SYSTEM_PATH%</span> -FeatureName <span class="entry-code-highlight">%FEATURE%</span> -All</td>
            </tr>
        </table>
        <div class="entry-paragraph">
            <p class="entry-paragraph-content">
                The option <span class="entry-paragraph-inline-code">-All</span> will automatically install all prerequisite features. Notice that for features that are not included in Windows e.g. .NET Framework 3.5, option <span class="entry-paragraph-inline-code">-Source</span> is required to provide an offline source (located in <span class="entry-paragraph-inline-code">sources\sxs</span> folder in the mounted system) which is nominated as the only valid source by the option <span class="entry-paragraph-inline-code">-LimitedAccess.</span>
            </p>
        </div>
        <table class="entry-code">
            <tr class="entry-code-line">
                <td class="entry-code-line-number">1</td>
                <td class="entry-code-content">Enable-WindowsOptionalFeature -Path "D:\Windows" -FeatureName NetFx3 -All -LimitAccess -Source "D:\Windows\sources\sxs"</td>
            </tr>
        </table>
        <div class="entry-paragraph">
            <p class="entry-paragraph-content">
                Finally, commit changes and save the image.
            </p>
        </div>
        <table class="entry-code">
            <tr class="entry-code-line">
                <td class="entry-code-line-number">1</td>
                <td class="entry-code-content">Dismount-WindowsImage -Path "D:\Windows" -Save</td>
            </tr>
        </table>
    </main>
</body>