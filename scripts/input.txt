startsection
entrytitlesection
Editing and repacking Windows images
2022-11-09

startsection
paragraphsection
titlesection
caonima
All commands are executed in elevated PowerShell, but Command Prompt should suffice. [efi\source\install.wim] is first extracted from the .iso file, and mounted using the following command.

startsection
codesection
Mount-WindowsImage -ImagePath [%WIM_PATH%] -Index [%IMAGE_INDEX%]

startsection
paragraphsection
In which [%IMAGE_INDEX%] is the order of the system in the image, starting from 1. For example, in (LTSC) 2021, the normal variant is numbered 1, and the IoT variant 2.
Two commands are used in this article: [Add-AppxProvisionedPackage] to install application packages and [Enable-WindowsOptionalFeature] to enable optional features. The former is used to install App Installer, which already includes winget.
{https://store.rg-adguard.net/}{Microsoft Store Generation Project} by adguard can be used to generate download link for the application package and its dependencies. Respective certificates can be downloaded from winget's GitHub Repo. This is however unnecessary for most application.

startsection
codesection
Add-AppxProvisionedPackage -Path [%MODIFIED_SYSTEM_PATH%] -Folder [%APPX-PATH%]

startsection
paragraphsection
In which [%MODIFIED_SYSTEM_PATH%] is the root directory of mounted system, and [%APPX-PATH%] is a folder containing all required files (application package itself, dependencies and certificate).
The latter is used to enable optional features that are disabled by default e.g. WSL and Hyper-V.
[Get-WindowsOptionalFeature] can be used to obtain alias for desired feature.

startsection
codesection
Get-WindowsOptionalFeature -Online

...
FeatureName : Microsoft-Windows-Subsystem-Linux
State : Disabled
...

startsection
codesection
Enable-WindowsOptionalFeature -Path [%MODIFIED_SYSTEM_PATH%] -FeatureName [%FEATURE%] -All

startsection
paragraphsection
The option [-All] will automatically install all prerequisite features. Notice that for features that are not included in Windows, for example .NET Framework 3.5, option [-Source] is required to provide an offline source (located in [sources\sxs] folder in the mounted system) which is nominated as the only valid source by the option [-LimitedAccess.]

startsection
codesection
Enable-WindowsOptionalFeature -Path "D:\Windows" -FeatureName NetFx3 -All -LimitAccess -Source "D:\Windows\sources\sxs"

startsection
paragraphsection
Finally, commit changes and save the image.

startsection
codesection
Dismount-WindowsImage -Path "D:\Windows" -Save